STRATEGIC_FRAMEWORKS = {
    # BRAND STRATEGY FRAMEWORKS
    "jobs_to_be_done": {
        "name": "Jobs To Be Done (JTBD)",
        "source": "Clayton Christensen / Harvard Business School",
        "use_when": ["new product launch", "repositioning", "innovation", "understanding customer motivation"],
        "description": "Focus on the functional, emotional, and social 'jobs' customers hire your product to do.",
        "key_questions": [
            "What job is the customer trying to get done?",
            "What are the functional, emotional, and social dimensions?",
            "What workarounds are they currently using?"
        ]
    },
    
    "category_entry_points": {
        "name": "Category Entry Points (CEPs)",
        "source": "Ehrenberg-Bass Institute / Byron Sharp",
        "use_when": ["brand awareness", "mental availability", "market penetration", "broad reach campaigns"],
        "description": "Identify all the situations, needs, and triggers that bring your category to mind.",
        "key_questions": [
            "When and where do people think of this category?",
            "Which entry points are most frequent and most ownable?",
            "How can we link our brand to more entry points?"
        ]
    },
    
    "brand_archetypes": {
        "name": "Brand Archetypes",
        "source": "Carl Jung / Margaret Mark",
        "use_when": ["brand identity", "tone of voice", "repositioning", "emotional connection"],
        "description": "Align brand personality with universal archetypes (Hero, Caregiver, Rebel, etc.).",
        "key_questions": [
            "Which archetype best represents the brand's role in customers' lives?",
            "What emotional territory does this archetype own?",
            "How should the brand speak, act, and appear?"
        ]
    },
    
    "cultural_tension": {
        "name": "Cultural Tension / Resolution",
        "source": "Classic advertising strategy",
        "use_when": ["campaign development", "creative briefs", "cultural relevance", "purpose-driven work"],
        "description": "Identify a tension in culture that the brand can authentically resolve.",
        "key_questions": [
            "What tension exists in culture right now?",
            "How does our brand have permission to address it?",
            "What's the resolution we're offering?"
        ]
    },
    
    "mental_physical_availability": {
        "name": "Mental & Physical Availability",
        "source": "Byron Sharp / How Brands Grow",
        "use_when": ["market growth", "distribution strategy", "brand salience", "reach optimization"],
        "description": "Growth comes from being easy to think of (mental) and easy to buy (physical).",
        "key_questions": [
            "How mentally available is the brand across buying situations?",
            "How easy is it to find and purchase?",
            "What distinctive brand assets drive recognition?"
        ]
    },
    
    # COMPETITIVE STRATEGY FRAMEWORKS
    "blue_ocean": {
        "name": "Blue Ocean Strategy",
        "source": "W. Chan Kim & Renée Mauborgne",
        "use_when": ["differentiation", "new market creation", "avoiding competition", "innovation"],
        "description": "Create uncontested market space rather than competing in crowded markets.",
        "key_questions": [
            "What factors can we eliminate that the industry takes for granted?",
            "What factors can we reduce well below industry standard?",
            "What factors can we raise or create that the industry has never offered?"
        ]
    },
    
    "porters_five_forces": {
        "name": "Porter's Five Forces",
        "source": "Michael Porter / Harvard Business School",
        "use_when": ["competitive analysis", "market entry", "strategic planning", "threat assessment"],
        "description": "Analyze competitive intensity through five structural forces.",
        "key_questions": [
            "What's the threat of new entrants and substitutes?",
            "What's the bargaining power of buyers and suppliers?",
            "How intense is competitive rivalry?"
        ]
    },
    
    "positioning": {
        "name": "Positioning Strategy",
        "source": "Al Ries & Jack Trout",
        "use_when": ["differentiation", "competitive response", "brand strategy", "messaging"],
        "description": "Own a word or concept in the prospect's mind relative to competition.",
        "key_questions": [
            "What position do we own or can we own?",
            "What position does competition own?",
            "What's the ladder in the customer's mind?"
        ]
    },
    
    # CREATIVE & MESSAGING FRAMEWORKS
    "stepps": {
        "name": "STEPPS (Virality Framework)",
        "source": "Jonah Berger / Contagious",
        "use_when": ["viral content", "word of mouth", "social campaigns", "earned media"],
        "description": "Six principles that drive sharing: Social Currency, Triggers, Emotion, Public, Practical Value, Stories.",
        "key_questions": [
            "Does this make people look good (Social Currency)?",
            "What will trigger people to think of this?",
            "What emotion does this evoke? Is it high arousal?"
        ]
    },
    
    "elaboration_likelihood": {
        "name": "Elaboration Likelihood Model (ELM)",
        "source": "Petty & Cacioppo",
        "use_when": ["persuasion strategy", "messaging depth", "audience targeting", "ad creative"],
        "description": "Match persuasion approach to audience involvement level (central vs. peripheral routes).",
        "key_questions": [
            "How motivated and able is the audience to process our message?",
            "Should we use strong arguments (central) or cues/heuristics (peripheral)?",
            "What's the right balance of information vs. emotion?"
        ]
    },
    
    "dramatic_structure": {
        "name": "Dramatic Structure / Story Arc",
        "source": "Classic narrative theory",
        "use_when": ["storytelling", "content strategy", "brand narrative", "campaign arcs"],
        "description": "Build narrative tension through setup, conflict, and resolution.",
        "key_questions": [
            "Who is the protagonist (customer, not brand)?",
            "What's the conflict or obstacle?",
            "What transformation occurs?"
        ]
    },
    
    # BEHAVIORAL & DECISION FRAMEWORKS
    "behavioral_economics": {
        "name": "Behavioral Economics Principles",
        "source": "Kahneman, Thaler, Ariely",
        "use_when": ["conversion optimization", "choice architecture", "pricing", "habit formation"],
        "description": "Apply cognitive biases and heuristics to influence decisions.",
        "key_questions": [
            "What defaults, anchors, or frames can we use?",
            "How can we reduce friction and increase salience?",
            "What social proof or loss aversion can we leverage?"
        ]
    },
    
    "customer_journey": {
        "name": "Customer Journey Mapping",
        "source": "Service design / IDEO",
        "use_when": ["experience design", "touchpoint strategy", "funnel optimization", "CX improvement"],
        "description": "Map every touchpoint and emotion across the customer lifecycle.",
        "key_questions": [
            "What are the key moments of truth?",
            "Where are the pain points and drop-offs?",
            "Where can we exceed expectations?"
        ]
    },
    
    "fogg_behavior": {
        "name": "Fogg Behavior Model",
        "source": "BJ Fogg / Stanford",
        "use_when": ["behavior change", "habit formation", "app engagement", "health campaigns"],
        "description": "Behavior happens when Motivation, Ability, and Prompt converge.",
        "key_questions": [
            "Is motivation high enough?",
            "Is the behavior easy enough?",
            "Is there a clear prompt at the right moment?"
        ]
    },
    
    # MEDIA & CHANNEL FRAMEWORKS
    "paid_owned_earned": {
        "name": "Paid / Owned / Earned Media",
        "source": "Forrester",
        "use_when": ["media planning", "channel strategy", "budget allocation", "integrated campaigns"],
        "description": "Balance investment across paid, owned, and earned channels.",
        "key_questions": [
            "What's the right mix given objectives?",
            "How can paid spark earned?",
            "What owned assets can we leverage?"
        ]
    },
    
    "see_think_do_care": {
        "name": "See-Think-Do-Care",
        "source": "Avinash Kaushik / Google",
        "use_when": ["funnel strategy", "content planning", "audience segmentation", "measurement"],
        "description": "Match content and channels to customer intent stages.",
        "key_questions": [
            "What does the audience need at each stage?",
            "What content and channels fit each stage?",
            "How do we measure success at each stage?"
        ]
    },
    
    # INNOVATION FRAMEWORKS
    "design_thinking": {
        "name": "Design Thinking",
        "source": "IDEO / Stanford d.school",
        "use_when": ["innovation", "problem solving", "product development", "human-centered design"],
        "description": "Empathize, Define, Ideate, Prototype, Test — iterate rapidly.",
        "key_questions": [
            "What does the user actually need (not what they say)?",
            "How might we reframe the problem?",
            "What's the fastest way to test our assumptions?"
        ]
    },
    
    "lean_startup": {
        "name": "Lean Startup / MVP",
        "source": "Eric Ries",
        "use_when": ["new ventures", "product launch", "market testing", "resource constraints"],
        "description": "Build-Measure-Learn loops with minimum viable products.",
        "key_questions": [
            "What's the riskiest assumption?",
            "What's the smallest experiment to test it?",
            "What will we learn and how will we pivot?"
        ]
    },
    
    # CRISIS & REPUTATION FRAMEWORKS
    "situational_crisis": {
        "name": "Situational Crisis Communication Theory (SCCT)",
        "source": "Timothy Coombs",
        "use_when": ["crisis response", "reputation management", "PR strategy", "issue management"],
        "description": "Match response strategy to crisis type and attribution of responsibility.",
        "key_questions": [
            "How much responsibility is attributed to the organization?",
            "What's the crisis history and prior reputation?",
            "Deny, diminish, rebuild, or bolster?"
        ]
    }
}

def select_frameworks(user_need: str, context_data: dict = None) -> list:
    """
    Analyze user need and select 2-3 most relevant frameworks.
    Returns list of framework keys.
    """
    user_need_lower = user_need.lower()
    
    # Scoring based on keyword matching
    scores = {}
    
    for key, framework in STRATEGIC_FRAMEWORKS.items():
        score = 0
        
        # Check use_when conditions
        for condition in framework["use_when"]:
            if any(word in user_need_lower for word in condition.split()):
                score += 2
        
        # Check name match
        if any(word in user_need_lower for word in framework["name"].lower().split()):
            score += 3
            
        scores[key] = score
    
    # Keyword boosts for common scenarios
    keyword_boosts = {
        "launch": ["jobs_to_be_done", "category_entry_points", "lean_startup"],
        "awareness": ["mental_physical_availability", "category_entry_points", "paid_owned_earned"],
        "viral": ["stepps", "cultural_tension", "dramatic_structure"],
        "crisis": ["situational_crisis", "positioning"],
        "differentiat": ["blue_ocean", "positioning", "brand_archetypes"],
        "competitor": ["porters_five_forces", "positioning", "blue_ocean"],
        "campaign": ["cultural_tension", "stepps", "see_think_do_care"],
        "rebrand": ["brand_archetypes", "positioning", "cultural_tension"],
        "content": ["stepps", "dramatic_structure", "see_think_do_care"],
        "conversion": ["behavioral_economics", "fogg_behavior", "customer_journey"],
        "health": ["fogg_behavior", "elaboration_likelihood", "customer_journey"],
        "pharma": ["elaboration_likelihood", "customer_journey", "situational_crisis"],
        "startup": ["lean_startup", "jobs_to_be_done", "blue_ocean"],
        "innovation": ["design_thinking", "jobs_to_be_done", "blue_ocean"],
        "social": ["stepps", "cultural_tension", "paid_owned_earned"],
        "purpose": ["cultural_tension", "brand_archetypes", "dramatic_structure"],
        "reposit": ["positioning", "brand_archetypes", "blue_ocean"],
    }
    
    for keyword, frameworks in keyword_boosts.items():
        if keyword in user_need_lower:
            for f in frameworks:
                scores[f] = scores.get(f, 0) + 3
    
    # Sort by score and return top 2-3
    sorted_frameworks = sorted(scores.items(), key=lambda x: x[1], reverse=True)
    
    # Return top 2, or top 3 if third has same score as second
    top = [f[0] for f in sorted_frameworks[:2]]
    if len(sorted_frameworks) > 2 and sorted_frameworks[2][1] == sorted_frameworks[1][1]:
        top.append(sorted_frameworks[2][0])
    
    # Default fallback if no matches
    if not top or all(scores[t] == 0 for t in top):
        top = ["cultural_tension", "category_entry_points"]
    
    return top

def get_framework_prompt(framework_keys: list) -> str:
    """
    Generate prompt text explaining selected frameworks.
    """
    lines = ["STRATEGIC FRAMEWORKS APPLIED:", ""]
    
    for key in framework_keys:
        f = STRATEGIC_FRAMEWORKS.get(key, {})
        if f:
            lines.append(f"**{f['name']}** ({f['source']})")
            lines.append(f"{f['description']}")
            lines.append("Key questions to address:")
            for q in f['key_questions']:
                lines.append(f"  - {q}")
            lines.append("")
    
    lines.append("Apply these frameworks explicitly in your recommendations. Show your strategic reasoning.")
    
    return "\n".join(lines)
